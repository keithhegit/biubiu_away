# Project Arrow Escape - Design & Development Document

## 1. 项目概况 (Project Overview)
**项目名称**: Arrow Escape (箭头消除 / 箭头逃逸)
**类型**: 益智解谜 / 逻辑类 H5 小游戏
**核心玩法**: 类似“拆积木”或“停车大师”。玩家需要按照正确的顺序点击“贪吃蛇”形状的箭头，使其沿着指向飞出屏幕。如果路径被阻挡，则扣除 HP。
**平台**: 移动端 H5 (PWA), 托管于 Cloudflare Pages。
**视觉风格**: 科技蓝图风格 (Technical Blueprint)，深蓝色系 (Deep Navy/Indigo)，点阵网格背景。

---

## 2. 产品需求 (Product Requirements)

### 2.1 核心机制
1.  **对象 (Snake Arrow)**:
    *   由“头”、“身体片段”和“尾巴”组成。
    *   长度不一 (2格 ~ 16格)。
    *   形状多样 (直线、L形、U形、复杂折线)。
    *   每个对象有一个固定的移动方向 (上、下、左、右)。
2.  **交互规则**:
    *   **点击**: 用户点击任意箭头对象。
    *   **判定**:
        *   **成功**: 如果箭头指向的路径上没有其他*静止*的箭头阻挡，该箭头变为 `moving` 状态，播放“咻”音效，并沿方向飞出屏幕边界。
        *   **失败**: 如果路径上有障碍物，箭头变为 `stuck` 状态，播放震动动画 (Shake)，播放报错音效，并扣除 1 点 HP。
3.  **胜利条件**: 屏幕上所有箭头都被消除。
4.  **失败条件**: HP 归零 (初始 HP 为 3)。

### 2.2 关卡设计
*   **总关卡数**: 50 关。
*   **难度曲线**:
    *   **Level 1 (新手)**: 12x9 网格，约 15 个对象，结构简单，用于教学。
    *   **Level 2+ (进阶)**: 24x14 网格，约 40+ 个对象，高密度，高纠缠度。
    *   **生成算法**: 采用“逆向依赖堆叠”算法 (Safe Stacking / Reverse Dependency)，保证生成的关卡一定有解。

### 2.3 UI/UX
*   **头部 (Header)**: 显示当前关卡 (Level)、剩余生命 (HP Hearts)、耗时 (Time)。
*   **游戏区 (Board)**: 点阵背景，无边框设计，适应各种屏幕比例。
*   **反馈**:
    *   点击会有缩放反馈。
    *   受伤会有屏幕震动反馈。
    *   过关会有弹窗结算。

---

## 3. 技术架构 (Technical Architecture)

### 3.1 技术栈
*   **Framework**: React 19
*   **Language**: TypeScript
*   **Styling**: Tailwind CSS
*   **Build Tool**: Vite (implied by usage)
*   **Audio**: Web Audio API (无外部资源依赖，纯代码生成音效)

### 3.2 核心模块
1.  **`hooks/useGameLogic.ts`**:
    *   管理游戏主循环 (Interval)。
    *   处理移动逻辑 (位置更新、离屏销毁)。
    *   处理点击碰撞检测。
    *   状态管理 (HP, Level, Score)。
2.  **`utils/generator.ts`**:
    *   程序化生成关卡。
    *   **算法逻辑**:
        1.  随机选择一个空位作为“头”。
        2.  随机选择一个离屏方向。
        3.  反向生长身体 (Reverse Walk)。
        4.  **关键检查**: 新生成的蛇**不能**阻挡任何**已存在**蛇的逃生路径。这确保了依赖关系是有向无环图 (DAG)，保证必有解。
3.  **`components/GameBoard.tsx`**:
    *   渲染层。
    *   Grid 层: CSS Grid 绘制背景点。
    *   Object 层: SVG 覆盖层，用于绘制复杂的蛇形路径。

---

## 4. 已知问题与待办事项 (Known Issues & Roadmap)

### 🔴 紧急 Bug (Critical Bugs)

#### 🐛 Bug-001: 关卡2 点击判定失效与误触
*   **现象描述**:
    > "我在测试关卡2， 右上角2个对象 红框里面的。从规则上点击就会消除往右飞出网格边界的。但是现在测试点击只是震动了一下，没有生效，也没有扣HP。"
*   **问题分析**:
    1.  **判定逻辑**: 当前点击事件绑定在 SVG 的 `<path>` 元素上。
    2.  **层级遮挡 (Z-Index)**: 在高密度关卡中，程序生成的顺序决定了渲染顺序。后生成的蛇（图层在上）的透明点击热区 (Hitbox,目前设置为 1.4倍格宽) 可能覆盖了先生成的蛇（图层在下）。
    3.  **误判**: 用户以为点击的是“视觉上可见”的蛇 A，但实际上捕捉到的是“不可见热区”的蛇 B。
    4.  **震动无扣血**: 如果逻辑判断该蛇是 `stuck` 状态，代码中会设置 `state: stuck` 并触发 CSS 动画。关于“没扣HP”，可能是因为误触到的蛇 B 确实被堵住了，但 UI 更新可能因为 React 批处理或状态覆盖没看清，或者确实存在状态更新的 Bug。
*   **解决方案 (Solution Plan)**:
    *   [ ] **弃用 DOM 点击**: 移除 `SnakeArrow` 组件上的 `onClick`。
    *   [ ] **实现几何点击检测**: 在 `GameBoard` 这一层监听全局点击坐标 `(x, y)`。
    *   [ ] **距离计算**: 遍历所有蛇，计算点击点到每条蛇的“骨架线段”的最短距离。
    *   [ ] **选择最近**: 选择距离最近（且距离小于阈值，如 0.8 * CellSize）的那条蛇作为交互对象。
    *   这将彻底解决层级遮挡和误触问题。

### 📅 开发计划 (Roadmap)

#### Phase 1: 核心体验修复 (Current)
- [ ] **Fix**: 实现上述的“几何距离点击检测”算法。
- [ ] **Fix**: 优化 HP 扣除的视觉反馈（整个屏幕边缘泛红或更明显的震动），确认扣血逻辑无误。
- [ ] **Tune**: 微调关卡 2 的生成参数，确保虽然难，但不会出现纯视觉上的“死局感”。

#### Phase 2: UI 细节打磨
- [ ] **Feat**: 增加“撤销”功能 (Undo)。
- [ ] **Feat**: 增加“提示”功能 (Hint)，高亮当前可以消除的一条蛇。
- [ ] **UI**: 优化开始界面和关卡选择界面。

#### Phase 3: PWA & 发布
- [ ] **PWA**: 完善 `manifest.json` 和离线缓存策略。
- [ ] **Deploy**: 配置 Cloudflare Pages 构建脚本。

---

## 5. 特定代码逻辑备忘

### 坐标系
*   `r` (row): Y轴，从上到下增加。
*   `c` (col): X轴，从左到右增加。

### 状态机
*   `idle`: 静止，可交互。
*   `moving`: 正在飞出，不可交互，不视为障碍物。
*   `stuck`: 刚被点击但受阻，播放震动动画，不可交互。

### 颜色规范 (Dark Navy Theme)
*   Main: `#1a237e` (Indigo 900)
*   Accent: `#3b82f6` (Blue 500)
*   Danger: `#ef4444` (Red 500)